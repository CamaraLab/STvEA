---
title: "Using STvEA to analyze CODEX data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in CODEX data
```{r}
data("codex_balbc1")
codex_balbc1 <- read.table("../../PGC001.a10/data/BALBc-1.csv", sep=",", stringsAsFactors = FALSE, header=TRUE)
row.names(data) <- paste("codex_",row.names(data),sep="")
expression <- cbind(data[, 1:29], MHCII=data$MHCII)
expression <- expression[,colnames(protein_expr_full)]
blanks <- data[,grepl("blank", colnames(data))]
x <- data$X.X
x <- floor((data$tile_nr.tile_nr-1)/9) * max(data$X.X) + x
y <- data$Y.Y
y <- ((data$tile_nr.tile_nr - 1) %% 9) * max(data$Y.Y) + y
z <- data$Z.Z
spatial <- cbind(x,y,z)
row.names(spatial) <- row.names(expression)
```

## Create object to hold data
```{r}
stvea_object <- SetDataCODEX(codex_protein = expression, codex_blanks = blanks, codex_size = data$size.size, codex_spatial = as.data.frame(spatial), stvea_object = stvea_object)
```

## Filter and clean protein expression
```{r}
stvea_object <- FilterCODEX(stvea_object, size_lim = c(1000,25000), blank_lower = c(-1200, -1200, -1200, -1200), blank_upper = c(6000,2500,5000,2500))

stvea_object <- CleanCODEX(stvea_object)
```

## Louvain clustering on KNN from UMAP
```{r}
stvea_object <- GetVisUMAP(stvea_object, metric = 'pearson', n_neighbors=50, min_dist=0.1, negative_sample_rate = 100)

stvea_object <- ClusterCodex(stvea_object, k=50)
```


